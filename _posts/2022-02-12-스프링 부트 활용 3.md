---
layout: single
title: \[강의요약\] 스프링부트 개념과 활용 - 스프링 웹 MVC (1)
date: 2022-02-11 20:52:00 +0900
categories: lecture_summary springboot springboot_getting_started
toc: true
toc_sticky: true
toc_label: Contents
---

개인적인 학습을 위한 [Inflearn - 스프링부트 개념과 활용](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8/dashboard)(백기선) 강의 요약입니다.

개념과 원리 위주로 요약합니다.

[이전 글](https://cherrue.github.io/lecture_summary/springboot/springboot_getting_started/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%B6%80%ED%8A%B8-%ED%99%9C%EC%9A%A9-2/) 에서 이어집니다.

# 4부. 스프링 부트 활용

---

## 7. 스프링 웹 MVC 1부 : 소개

7-1. 스프링 부트 MVC 를 이용해 간단한 테스트 만들기

프로젝트 만들기 : spring-boot-starter-web, test 주입

```java
// UserControllerTest.java
@RunWith(SpringRunner.class)
@WebMvcTest(UserController.class)
public class UserControllerTest {

    @Autowired
    MockMvc mockMvc;

    @Test
    public void hello() throws Exception {
        mockMvc.perform(get("/hello"))
                .andExpect(status().isOk())
                .andExpect(content().string("hello"));
    }
}

// UserController
@RestController
public class UserController {
    @GetMapping("/hello")
    public String hello() {
        return "hello";
    }
}
```

MockMvc : WebMvcTest 어노테이션을 사용하면 주입받을 수 있는 객체

위와 같이 코딩하면 간단한 MVC를 바로 만들어서 쓴 것

가능한 이유 : spring-boot-autoconfigurer > spring.factories > WebMvcAutoConfiguration 이 자동 적용

7-2. 스프링 MVC 확장과 재정의

자동 설정의 기본 기능에서 **추가**로 설정하고 싶다면? 확장 = @Configuration + WebMvcConfigurer

자동 설정의 기본 기능들도 모두 내가 설정하고 싶다면? 재정의 = @Configuration + @EnableWebMvc

```java
@Configuration
//@EnableWebMvc : 이걸 붙이면 기본 설정이 다 없어짐
public class WebConfig implements WebMvcConfigurer {
//    void configureAsyncSupport(AsyncSupportConfigurer configurer) {}
// WebMvcConfigurer 에 선언된 함수를 구현하면 된다.
}
```


## 8. HttpMessageConverters

HttpMessageConverters : Http 요청 본문을 역직렬화하거나, 객체를 응답으로 직렬화할 때 사용

- @RequestBody, @ResponseBody 가 붙으면 알아서 사용됨
- @RestController인 경우에는 @ResponseBody 생략 가능
- @Controller를 사용하는 경우 View Name Resolver가 view 파일을 찾음

```java
@RestController
public class UserController {
    @GetMapping("/hello")
    public String hello() {
        return "hello";
    }

    @PostMapping("/user")
    //public @ResponseBody User Create(@RequestBody User user) {
    public /*@ResponseBody*/ User Create(@RequestBody User user) {
        return null;
    }
}
```

content-type 헤더에 따라 사용되는 컨버터가 바뀜

여러 종류의 값이 포함된 객체라면(컴포지션 하다면) Json이 기본적으로 사용됨

 ↔ 문자열 하나면 StringConverter가 사용됨

8-1. 유저 생성 테스트 코드 작성

🚧 User 객체는 자바빈 규약에 따라 getter/setter 를 가져야 한다.

```java
		
// test.user.UserControllerTest.java
		@Test
    public void createUser_JSON() throws Exception {
        String userJson = "{\n" +
                "  \"username\": \"cherrue\",\n" +
                "  \"password\": \"123\"\n" +
                "}";
        mockMvc.perform(post("/users/create")
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_JSON_UTF8)
                .content(userJson))
                    .andExpect(status().isOk())
                    .andExpect(jsonPath("$.username", is(equalTo("cherrue"))))
                    .andExpect(jsonPath("$.password", is(equalTo("123"))));
    }

// UserController.Java
@RestController
public class UserController {
    @GetMapping("/hello")
    public String hello() {
        return "hello";
    }

    //public @ResponseBody User Create(@RequestBody User user) {
    @PostMapping("/users/create")
    public /*@ResponseBody*/ User Create(@RequestBody User user) {
        return user;
    }
}

// User.java
public class User {
    private Long id;

    private String username;

    private String password;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

}
```

## 9. ViewResolve

요청의 포맷 : header > contentType

응답의 포맷 : accept header

accept header 가 없다면?<br/>
어떤 요청이 들어오면 그 요청으로 만들 수 있는 모든 답을 찾아낸다<br/>
최종적으로 accept header를 보고 제일 적절한 걸 반환<br/>
accept header가 안 들어오는 요청은 format(/path?format=pdf) 이라는 파라미터를 받을 수 있다.

```java
// UserControllerTest.java
		@Test
    public void createUser_XML() throws Exception {
        String userJson = "{\n" +
                "  \"username\": \"cherrue\",\n" +
                "  \"password\": \"123\"\n" +
                "}";
        mockMvc.perform(post("/users/create")
                .contentType(MediaType.APPLICATION_JSON_UTF8)
                .accept(MediaType.APPLICATION_XML)
                .content(userJson))
                    .andExpect(status().isOk())
                .andExpect(xpath("/User/username").string("cherrue"))
                .andExpect(xpath("/User/password").string("123"));
    }
```

위 테스트 소스를 작성하면 알아서 XML로 뱉어지는데, ContentNegotiatingViewResolver가 작업해 준 것

**결과**

```java
Resolved Exception:
             Type = org.springframework.web.HttpMediaTypeNotAcceptableException

java.lang.AssertionError: Status 
Expected :200
Actual   :406
```

📌 문제발생 XML 메시지 컨버터가 없어서 406 에러 발생

HttpMessageConvertersConfiguration > JacksonHttpMessageConvertersConfiguration

```java
		@ConditionalOnClass({XmlMapper.class}) // XmlMapper가 있을 때 등록하라는 설정
    @ConditionalOnBean({Jackson2ObjectMapperBuilder.class})
    protected static class MappingJackson2XmlHttpMessageConverterConfiguration {
        protected MappingJackson2XmlHttpMessageConverterConfiguration() {
        }

        @Bean
        @ConditionalOnMissingBean
        public MappingJackson2XmlHttpMessageConverter mappingJackson2XmlHttpMessageConverter(Jackson2ObjectMapperBuilder builder) {
            return new MappingJackson2XmlHttpMessageConverter(builder.createXmlMapper(true).build());
        }
    }
```

🎀 해결 : XmlMapper을 클래스 패스에 추가하기 = 의존성 추가하기

```java
// Pom.xml
				<dependency>
            <groupId>com.fasterxml.jackson.dataformat</groupId>
            <artifactId>jackson-dataformat-xml</artifactId>
            <version>2.9.6</version>
        </dependency>
```

**결과 : 성공하면 아무것도 출력하지 않는다.**

![test_passed](/assets/images/2022-02-15/test_passed.png)