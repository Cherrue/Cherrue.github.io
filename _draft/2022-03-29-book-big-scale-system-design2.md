# 7장. 분산 시스템을 위한 유일 ID 생성기 설계

## 1. 유일 ID 생성 방법

### 1-1. 다중 마스터 복제

id를 auto increase 하되, 1이 아닌 서버의 대수 만큼씩 증가

장점

- ID 유일성 보장
- 서버의 대수를 늘리면 초당 생산 가능 ID 수를 늘릴 수 있음

단점

- 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다
- ID가 시간과 비례함을 보장할 수 없다
- 서버를 추가하거나 삭제할 때 잘 동작하기 어렵다

### 1-2. UUID

각 서버의 ID 생성기가 128비트 랜덤 문자열 부여

장점

- 서버 사이의 조율이 필요 없어 동기화 이슈가 없음
- 각 서버가 각자 ID 생성기를 갖기 때문에 규모 확장이 쉽다

단점

- 길이가 길다.
- ID가 시간과 비례하지 않는다
- 숫자가 아닌 문자열이다

### 1-3. 티켓 서버

auto increase로 ID를 발행하는 티켓 서버를 구축하고 DB는 이 티켓서버를 통해 ID를 받는다

장점

- 요구사항을 만족시키는 ID를 만들기 쉽다
- 구현이 쉽다

단점

- 티켓서버가 SPOF 가 된다.
- 티켓 서버 이중화 시 동기화 이슈가 있다.

### 1-4. 트위터 스노플레이크

ID를 비트 단위로 의미를 부여한다.

buffer + timestamp + data center ID + server ID + 일련번호

장점

- 요구사항을 만족시키는 ID를 만들기 쉽다

단점

- 요구사항을 제대로 식별해야 한다
- ID의 형태를 변경하기 어렵다.

## 2. 단계별 설계

### 1단계 문제 이해 및 설계 범위 확정

- 유일성
- 자료형
- 크기
- 정렬
- 단위 시간 당 생산 가능 개수

### 2단계 개략적인 설계안 제시 및 동의 구하기

- ID 생성 기법 선택

### 3단계 상세 설계

- 선택한 기법의 단위 시간당 ID 생산량 계산
- 해당 ID로 저장 가능한 최대 데이터 수
- 시간 값이 들어간다면, 저장 가능한 기간

### 4단계 마무리

추가 논의 사항

- 시계 동기화 : NTP 서버 구축
- 스노플레이크라면) 각 section 의 크기 최적화
- 고가용성 : 장애 대응 방법

# 8장. URL 단축기 설계

## 1. URL 단축기

### 1-1. 개념

긴 URL을 domain.com/{특정 길이의 문자열} 로 매핑하여 리다이렉트 해주는 서비스

### 1-2. 전제

- 입력으로 주어지는 URL이 다르면 결과 값도 달라야 한다
- 계산된 단축 값은 원래 URL로 복원되어야 한다.

## 2. URL 단축 방법

### 2-1. 해시 후 충돌 해소

해시 함수를 통해 url을 해시 값으로 바꾸고, 충돌 발생 시 충돌을 해결하는 방법

**필요한 설정**

- 해시의 길이 : 요구사항에 맞도록 선정
- 해시 함수 : CRC32, MD5, SHA-1 등 잘 알려진 함수를 쓰면 된다.
- 충돌 해소 : 해시 충돌이 발생하면 원래 URL에 사전에 정의한 문자열을 뒤에 붙여 다시 해시

**단점**

- 충돌의 발생을 DB 조회를 해야 알기 때문에 매 생성마다 DB 조회가 필수
    
    -> 데이터베이스 대신 블룸 필터를 사용하면 성능을 높일 수 있다
    

### 2-2. base-N 변환

URL을 숫자에 매칭하여 그걸 base-N = N진수의 수로 변환

**단점**

- URL의 길이에 따라 결과 길이가 가변적
- 유일성 보장 ID 생성기가 필요
- 생성기의 규칙이 뻔히 보이면 보안 문제 발생

## 3. 리디렉션 방법

### 3-1. 301 Permanently moved

해당 응답으로 리디렉션하면 브라우저가 이 응답을 캐시하여 다음 번 요청부터는 URL 단축기 서버에 가지 않음

### 3-2. 302 Found

이번 요청의 리디렉션만 유효. 같은 요청을 재용청하더라도 URL 단축기 서버에 가야 함

## 4. 단계별 설계

### 1단계 문제 이해 및 설계 범위 확정

**요구사항 식별**

- URL 생성 트래픽 규모
- 줄인 URL의 길이
- URL에 포함 가능한 문자 종류
- 생성한 URL의 갱신, 삭제 가능성
- 생성한 URL의 읽기 트래픽 규모
- 서비스 (예정) 기간
- 용량 추정 : url의 길이 * 생성 트래픽 규모 * 서비스 예정 기간

### 2단계 개략적 설계안 제시 및 동의 구하기

**URL 단축 서버의 주요 기능**

- URL 단축
- API 엔드포인트 : 생성 API, 읽기 API
- 리디렉션 : 301과 302 중 선택.
    
    → 301의 사용 : 서버 부하가 줄어들지만, 사용량 분석, 발생 위치 등의 트래픽 분석 불가
    
    → 302의 사용 : 서버 부하가 늘지만, 트래픽 분석에 강함
    

### 3단계 상세 설계

**데이터의 저장**

- 해시 테이블을 메모리에 저장 : 큰 서비스에 부적합
- 데이터베이스에 저장

**해시 함수 설계**

- URL에 사용 가능한 문자 개수 ^ 줄인 URL의 길이 = 매핑 가능한 URL의 개수
- URL 단축 방법의 선택 필요
- base-N 변환을 선택하면, ID 생성기를 개발해야 한다. 7장의 스노우플레이크가 좋겠지

**리디렉션 설계**

- 자주 호출되는 URL을 캐싱

### 4단계 마무리

**추가 고민**

- 처리율 제한 장치 : 단축 요청을 악의적으로 많이 보내올 수 있으니 방어
- 웹 서버의 규모 확장 : 이 서버는 stateless 한 웹서버로 개발이 가능해 규모 확장이 자유로움
- 데이터 분석 솔루션 : 어떤 링크를 얼마나 많은 사용자가 사용하는가 등
- 가용성, 데이터 일관성, 안정성
